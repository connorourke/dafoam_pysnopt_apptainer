# dafoam_pyoptsparse_snopt.def
Bootstrap: docker
From: dafoam/opt-packages:v3.1.2

%environment
    export DAFOAM_ROOT_PATH=/home/dafoamuser/dafoam
    export PATH=$DAFOAM_ROOT_PATH/packages/miniconda3/bin:$PATH
    export LD_LIBRARY_PATH=$DAFOAM_ROOT_PATH/packages/miniconda3/lib:$LD_LIBRARY_PATH
    export DAFOAM_NO_WARNINGS=1
    unset WM_CODI_AD_MODE
    export BUILD_DAFOAM=${BUILD_DAFOAM:-1}
    export BUILD_ADR=${BUILD_ADR:-1}
    export BUILD_ADF=${BUILD_ADF:-1}
    export BUILD_INCOMPRESSIBLE_ONLY=${BUILD_INCOMPRESSIBLE_ONLY:-1}
    export DAFOAM_HOST_SRC=${DAFOAM_HOST_SRC:./dafoam_custom}
    export PYSNOPT_HOST_SRC=${PYSNOPT_HOST_SRC:.pySNOPT/source}

%files
    pySNOPT/source /home/dafoamuser/dafoam/pySNOPT_source
    dafoam-custom /home/dafoamuser/dafoam/dafoam-custom

%post

    cd /home/dafoamuser/dafoam

    set +e
    . /home/dafoamuser/dafoam/loadDAFoam.sh
    set -e
   
    cd $DAFOAM_ROOT_PATH/repos

    wget https://github.com/mdolab/pyoptsparse/archive/v2.9.1.tar.gz -O pyoptsparse.tar.gz
    tar -xzf pyoptsparse.tar.gz -C $DAFOAM_ROOT_PATH/repos
    rm pyoptsparse.tar.gz

    cp -r $DAFOAM_ROOT_PATH/pySNOPT_source/*  $DAFOAM_ROOT_PATH/repos/pyoptsparse-2.9.1/pyoptsparse/pySNOPT/source/

    rm -rf $DAFOAM_ROOT_PATH/repos/pyoptsparse-2.9.1/build/*
    rm -rf $DAFOAM_ROOT_PATH/repos/pyoptsparse-2.9.1/pyoptsparse.egg-info/*

    pip install --force-reinstall $DAFOAM_ROOT_PATH/repos/pyoptsparse-2.9.1


    set +e

    if [ "$BUILD_DAFOAM" = "1" ]; then
        cd $DAFOAM_ROOT_PATH/dafoam-custom
        rm -rf build dist *.egg-info dafoam/*so

        . $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-v1812/etc/bashrc
        ./Allclean > clean_v1812.log 2>&1
        if [ "$BUILD_INCOMPRESSIBLE_ONLY" = "1" ]; then
            ./Allmake incompressible > build_v1812.log 2>&1
        else
            ./Allmake > build_v1812.log 2>&1
        fi

        if [ "$BUILD_ADR" = "1" ]; then
            . $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-v1812-ADR/etc/bashrc
            ./Allclean > clean_v1812_ADR.log 2>&1
            if [ "$BUILD_INCOMPRESSIBLE_ONLY" = "1" ]; then
                ./Allmake incompressible > build_v1812_ADR.log 2>&1
            else
                ./Allmake > build_v1812_ADR.log 2>&1
            fi
        fi

        if [ "$BUILD_ADF" = "1" ]; then
            . $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-v1812-ADF/etc/bashrc
            ./Allclean > clean_v1812_ADF.log 2>&1
            if [ "$BUILD_INCOMPRESSIBLE_ONLY" = "1" ]; then
                ./Allmake incompressible > build_v1812_ADF.log 2>&1
            else
                ./Allmake > build_v1812_ADF.log 2>&1
            fi
        fi
    fi

    # Install DAFOAM Python package
    python3 -m pip install . --no-deps --force-reinstall >> pip_install.log 2>&1
    set +e

    . $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-v1812/etc/bashrc
    ./Allclean > clean_v1812.log 2>&1
    ./Allmake incompressible > build_v1812.log 2>&1

    . $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-v1812-ADR/etc/bashrc
    ./Allclean > clean_v1812_ADR.log 2>&1
    ./Allmake incompressible > build_v1812_ADR.log 2>&1

    . $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-v1812-ADF/etc/bashrc
    ./Allclean > clean_v1812_ADF.log 2>&1
    ./Allmake incompressible > build_v1812_ADF.log 2>&1

    python3 -m pip install . --no-deps --force-reinstall >> pip_install.log 2>&1 

    set -e

%test
    . /home/dafoamuser/dafoam/loadDAFoam.sh

# Test if SNOPT is installed
$DAFOAM_ROOT_PATH/packages/miniconda3/bin/python - <<EOF
from pyoptsparse import OPT, pyOpt_error

try:
    OPT("SNOPT")  
    print("SNOPT is installed and enabled")
except pyOpt_error.Error:
    print("SNOPT is NOT available in this build.")
EOF
