# dafoam_pyoptsparse_snopt.def
Bootstrap: docker
From: dafoam/opt-packages:v3.1.2

%environment
    export DAFOAM_ROOT_PATH=/home/dafoamuser/dafoam
    export PATH=$DAFOAM_ROOT_PATH/packages/miniconda3/bin:$PATH
    export LD_LIBRARY_PATH=$DAFOAM_ROOT_PATH/packages/miniconda3/lib:$LD_LIBRARY_PATH

%files
    pySNOPT/source /home/dafoamuser/dafoam/pySNOPT_source

%post
    cd /home/dafoamuser/dafoam

    set +e
    . /home/dafoamuser/dafoam/loadDAFoam.sh
    set -e

    cd $DAFOAM_ROOT_PATH/repos

    wget https://github.com/mdolab/pyoptsparse/archive/v2.9.1.tar.gz -O pyoptsparse.tar.gz
    tar -xzf pyoptsparse.tar.gz -C $DAFOAM_ROOT_PATH/repos
    rm pyoptsparse.tar.gz

    cp -r $DAFOAM_ROOT_PATH/pySNOPT_source/*  $DAFOAM_ROOT_PATH/repos/pyoptsparse-2.9.1/pyoptsparse/pySNOPT/source/

    rm -rf $DAFOAM_ROOT_PATH/repos/pyoptsparse-2.9.1/build/*
    rm -rf $DAFOAM_ROOT_PATH/repos/pyoptsparse-2.9.1/pyoptsparse.egg-info/*

    pip install --force-reinstall $DAFOAM_ROOT_PATH/repos/pyoptsparse-2.9.1

%test
    . /home/dafoamuser/dafoam/loadDAFoam.sh

# Test if SNOPT is installed
$DAFOAM_ROOT_PATH/packages/miniconda3/bin/python - <<EOF
from pyoptsparse import OPT, pyOpt_error

try:
    OPT("SNOPT")  
    print("SNOPT is installed and enabled")
except pyOpt_error.Error:
    print("SNOPT is NOT available in this build.")
EOF